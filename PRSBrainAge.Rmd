---
title: "PRS BrainAge"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('PRSBrainAge.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/PRSBrainAge', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr);library(sjPlot);library(gtsummary); library(flextable);library(ppcor);library(nlme)


knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# Polygenetic Risk Score of BrainAge

```{r, include = FALSE}

# Load PRS
prs_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/prs_0.5.csv')

# Load factors
factors <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/factors.csv', na.strings = c("", " ", "NaN", "NA", NA))
data <- merge(prs_A4, factors, by = 'BID', all.x = TRUE)

# Amyloid status
covars <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/covariates.csv', na.strings = c("", " ", "NaN", "NA", NA))
covars$Amyloid <- ifelse(covars$Amyloid == 1, 'positive', 'negative')
covars$e4 <- ifelse(covars$e4 == 1, 'carrier', 'non-carrier')
data <- merge(data, covars[, c('BID', 'Amyloid', 'e4')], by = 'BID', all.x = TRUE)

# Demographics
demographics <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/raw/SUBJINFO.csv')
demographics <- demographics %>%
  rename(YearsEd = EDCCNTU) %>%
  rename(age = AGEYR) %>%
  mutate(SEX = recode(SEX, `1` = "Female", `2` = "Male"))
data <- merge(data, demographics, by = 'BID', all.x = TRUE)

# Tertiles
data$GM_tertiles <- cut(data$GM_ZSCORE, 
                       breaks = quantile(data$GM_ZSCORE, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
                       labels = c("1st", "2nd", "3rd"),
                       include.lowest = TRUE)
```

Cohort Demographics

```{r}
table <- tbl_summary(data,
            include = c(age, SEX, YearsEd, e4, Amyloid, pTau217, NF.L, GFAP),
            missing = "no",
            statistic = list(all_continuous()  ~ c("{mean} ({sd})")),
            label = list(age ~ "Age", YearsEd ~ "Education (Years)", NF.L ~ "NFL (pg/mL)", GFAP ~ "GFAP (ng/mL)", pTau217 ~ "pTau 217 (U/mL)"),
            digits = list(all_continuous() ~ 2, all_categorical() ~ c(0,2)),
            by = Amyloid) %>%
  modify_header(stat_1 = "**AB-**, N = {n}", stat_2 = "**AB+**, N = {n}") %>%
  add_p() %>%
  add_overall() %>%
  bold_labels()

table %>%
  as_flex_table() %>% 
  fontsize(size = 12, part = "all") %>%
  line_spacing(space = 1.5, part = "all") %>%
  autofit() %>%
  save_as_docx(path = "~/Downloads/DemographicsTable.docx")

table

```

## Division by SEX {.tabset}

### GM

```{r}
# Create a bloxpot groupbing by SEX
ggplot(subset(data, !is.na(SEX)), aes(x = SEX, y = GM_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by SEX',
       x = 'SEX',
       y = 'PRS Zscore')
```
### WM

```{r}
# Create a bloxpot groupbing by SEX
ggplot(subset(data, !is.na(SEX)), aes(x = SEX, y = WM_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by SEX',
       x = 'SEX',
       y = 'PRS Zscore')
```

### FC

```{r}
# Create a bloxpot groupbing by SEX
ggplot(subset(data, !is.na(SEX)), aes(x = SEX, y = FC_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by SEX',
       x = 'SEX',
       y = 'PRS Zscore')
```

## Division by E4 Status {.tabset}

### GM

```{r}
# Create a boxplot grouping by E4 status
ggplot(subset(data, !is.na(e4)), aes(x = e4, y = GM_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by E4 status',
       x = 'E4 status',
       y = 'PRS Zscore')

```

### WM

```{r}
# Create a boxplot grouping by E4 status
ggplot(subset(data, !is.na(e4)), aes(x = e4, y = WM_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by E4 status',
       x = 'E4 status',
       y = 'PRS Zscore')
```

### FC

```{r}
# Create a boxplot grouping by E4 status
ggplot(subset(data, !is.na(e4)), aes(x = e4, y = FC_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by E4 status',
       x = 'E4 status',
       y = 'PRS Zscore')
```

## Division by Amyloid Status {.tabset}

### GM

```{r}
# Create a boxplot grouping by Amyloid status

ggplot(subset(data, !is.na(Amyloid)), aes(x = Amyloid, y = GM_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by Amyloid status',
       x = 'Amyloid status',
       y = 'PRS Zscore')
```

### WM

```{r}
# Create a boxplot grouping by Amyloid status
ggplot(subset(data, !is.na(Amyloid)), aes(x = Amyloid, y = WM_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by Amyloid status',
       x = 'Amyloid status',
       y = 'PRS Zscore')
```

### FC

```{r}
# Create a boxplot grouping by Amyloid status
ggplot(subset(data, !is.na(Amyloid)), aes(x = Amyloid, y = FC_ZSCORE)) +
  geom_boxplot() +
  stat_compare_means(method = 't.test') +
  labs(title = 'PRS Zscore by Amyloid status',
       x = 'Amyloid status',
       y = 'PRS Zscore')
```

## Division by Age {.tabset}

### GM

``` {r}
# Create a scatter plot of PRS Zscore by Age
ggplot(subset(data, !is.na(age)), aes(x = age, y = GM_ZSCORE)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x)+
  stat_cor() +
  labs(title = 'PRS Zscore by Age',
       x = 'Age (years)',
       y = 'PRS Zscore')
```
### WM

``` {r}
# Create a scatter plot of PRS Zscore by Age
ggplot(subset(data, !is.na(age)), aes(x = age, y = WM_ZSCORE)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x)+
  stat_cor() +
  labs(title = 'PRS Zscore by Age',
       x = 'Age (years)',
       y = 'PRS Zscore')
```

### FC

``` {r}
# Create a scatter plot of PRS Zscore by Age
ggplot(subset(data, !is.na(age)), aes(x = age, y = FC_ZSCORE)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x)+
  stat_cor() +
  labs(title = 'PRS Zscore by Age',
       x = 'Age (years)',
       y = 'PRS Zscore')
```

## Division by Years of Education {.tabset}

### GM

``` {r}
# Create a scatter plot of PRS Zscore by Age
ggplot(subset(data, !is.na(YearsEd)), aes(x = YearsEd, y = GM_ZSCORE)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x)+
  stat_cor() +
  labs(title = 'PRS Zscore by Years of Education',
       x = 'Age (years)',
       y = 'PRS Zscore')
```

### WM

``` {r}
# Create a scatter plot of PRS Zscore by Age
ggplot(subset(data, !is.na(YearsEd)), aes(x = YearsEd, y = WM_ZSCORE)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x)+
  stat_cor() +
  labs(title = 'PRS Zscore by Years of Education',
       x = 'Education (years)',
       y = 'PRS Zscore')
```

### FC

``` {r}
# Create a scatter plot of PRS Zscore by Years Education
ggplot(subset(data, !is.na(YearsEd)), aes(x = YearsEd, y = FC_ZSCORE)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x)+
  stat_cor() +
  labs(title = 'PRS Zscore by Years of Education',
       x = 'Education (years)',
       y = 'PRS Zscore')
```

## General Linear Models with Blood Biomarkers

We build a general linear model that predict blood biomarkers using PRS, Age and PRS\*Age interaction

### pTau217 {.tabset}

#### GM

```{r}
model_ptau_gm <- glm(pTau217 ~ GM_ZSCORE*age, data = data)
summary(model_ptau_gm)
```

#### WM

```{r}
model_ptau_wm <- glm(pTau217 ~ WM_ZSCORE*age, data = data)
summary(model_ptau_wm)
```

#### FC

```{r}
model_ptau_fc <- glm(pTau217 ~ FC_ZSCORE*age, data = data)
summary(model_ptau_fc)
```

### NFL {.tabset}

#### GM

```{r}
model_nfl_gm <- glm(NF.L ~ GM_ZSCORE*age, data = data)
summary(model_nfl_gm)
```

#### WM

```{r}
model_nfl_wm <- glm(NF.L ~ WM_ZSCORE*age, data = data)
summary(model_nfl_wm)
```

#### FC

```{r}
model_nfl_fc <- glm(NF.L ~ FC_ZSCORE*age, data = data)
summary(model_nfl_fc)
```

### GFAP {.tabset}

#### GM

```{r}
model_gfap_gm <- glm(GFAP ~ GM_ZSCORE*age, data = data)
summary(model_gfap_gm)
```

#### WM

```{r}
model_gfap_wm <- glm(GFAP ~ WM_ZSCORE*age, data = data)
summary(model_gfap_wm)
```

#### FC

```{r}
model_gfap_fc <- glm(GFAP ~ FC_ZSCORE*age, data = data)
summary(model_gfap_fc)
```

## pTau217 and PRS GM analysis

Plot of pTau217 and PRS GM Zscore

```{r}
ggplot(subset(data, !is.na(pTau217)), aes(x = GM_ZSCORE, y = pTau217)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x)+
  stat_cor() +
  labs(title = 'Comparison of PRS to pTau217 at Baseline',
       x = 'PRS Zscore',
       y = 'pTau217')
```
General linear model plot

```{r}
# GLM
p <- plot_model(model_ptau_gm, type = c('pred'), terms = c('age', 'GM_ZSCORE [-1, 0, 1]'), show.values = TRUE)
p +
  ggtitle(NULL) +
  labs(color = 'Grey Matter PRS',
      x = 'Age (years)') +
# Make x-axis and y-axis more readable
  theme(
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 16)
  )
```


```{r}
# Scatter plot of GM Prs and pTau217 with best fit line
p <- plot_model(model_ptau_gm, type = c('pred'), terms = c('GM_ZSCORE'))+
  geom_point(data = data, aes(x = GM_ZSCORE, y = pTau217), 
             inherit.aes = F) +
  labs(title = NULL, 
       x = 'GM PRS Zscore',
       y = 'pTau217') 
p
```

### Sensitivity analysis {.tabset}

We cannot include Amyloid because pTau217 is only done in amyloid positive.

#### Tertiles

```{r}
model_ptau_tertiles <- lm(pTau217 ~ GM_tertiles*age, data = data)
summary(model_ptau_tertiles)
p <- plot_model(model_ptau_tertiles, type = c('pred'), terms = c('age', 'GM_tertiles [1st, 2nd, 3rd]'), show.values = TRUE)
p +
  ggtitle(NULL) +
  labs(color = 'Grey Matter PRS',
      x = 'Age (years)')
```
#### PRS 

```{r}
# Sensitivity analysis
model_ptau_prs <- lm(pTau217 ~ GM_ZSCORE*age + WM_ZSCORE*age + FC_ZSCORE*age, data = data)
summary(model_ptau_prs)
p <- plot_model(model_ptau_prs, type = c('pred'), terms = c('age', 'GM_ZSCORE [-1, 0, 1]'), show.values = TRUE)
p +
  ggtitle(NULL) +
  labs(color = 'Grey Matter PRS',
      x = 'Age (years)') +
# Make x-axis and y-axis more readable
  theme(
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 16)
  )
```

#### Sex, e4 and YearsEd

```{r}
# Sensitivity analysis
model_ptau_covars <- lm(pTau217 ~ GM_ZSCORE*age + WM_ZSCORE*age + FC_ZSCORE*age + SEX + e4 + YearsEd, data = data)
summary(model_ptau_covars)
```

#### Sex, e4 and YearsEd interaction with Age

```{r}
# Include interaction with age
model_ptau_covars_interactions <- lm(pTau217 ~ GM_ZSCORE*age + WM_ZSCORE*age + FC_ZSCORE*age + SEX*age + e4*age + YearsEd*age, data = data)
summary(model_ptau_covars_interactions)
```

#### Blood Biomarkers

```{r}
# Blood Biomarkers
model_ptau_blood <- lm(pTau217 ~ GM_ZSCORE*age + NF.L + GFAP, data = data)
summary(model_ptau_blood)
cor.test(data$pTau217, data$GFAP, method = 'pearson')
```


### Sex differences

Add sex interaction

```{r}
data$SEX <- as.factor(data$SEX)
model_ptau_sex <- lm(pTau217 ~ GM_ZSCORE*age*SEX, data = data)
summary(model_ptau_sex)
plot_model(model_ptau_sex, type = c('pred'), terms = c('age', 'GM_ZSCORE [-1, 0, 1]', 'SEX'), show.values = TRUE)
```

Stratified sex models

```{r}
model_ptau_male <- lm(pTau217 ~ GM_ZSCORE*age, data = subset(data, SEX == "Male"))
summary(model_ptau_male)
plot_model(model_ptau_male, type = c('pred'), terms = c('age', 'GM_ZSCORE [-1, 0, 1]'), show.values = TRUE)
```

```{r}
model_ptau_female <- lm(pTau217 ~ GM_ZSCORE*age, data = subset(data, SEX == "Female"))
summary(model_ptau_female)
plot_model(model_ptau_female, type = c('pred'), terms = c('age', 'GM_ZSCORE [-1, 0, 1]'), show.values = TRUE)
```

By tertiles

```{r}
model_ptau_sex_tertiles <- lm(pTau217 ~ GM_tertiles*age*SEX, data = data)
summary(model_ptau_sex_tertiles)
plot_model(model_ptau_sex_tertiles, type = c('pred'), terms = c('age', 'GM_tertiles', 'SEX'), show.values = TRUE)
```

```{r}
model_ptau_male_tertiles <- lm(pTau217 ~ GM_tertiles*age, data = subset(data, SEX == "Male"))
summary(model_ptau_male_tertiles)
plot_model(model_ptau_male_tertiles, type = c('pred'), terms = c('age', 'GM_tertiles'), show.values = TRUE)
```

```{r}
model_ptau_female_tertiles <- lm(pTau217 ~ GM_tertiles*age, data = subset(data, SEX == "Female"))
summary(model_ptau_female_tertiles)
plot_model(model_ptau_female_tertiles, type = c('pred'), terms = c('age', 'GM_tertiles'), show.values = TRUE)
```

### Effect on Longidutinal PACC

```{r}
# Load PACC data
pacc <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/longitudinal_PACC.csv')

# Filter subjects with less than 2 data points
pacc <- pacc %>% 
  arrange(BID, pacc_time) %>%  
  group_by(BID) %>% 
  add_tally(name = 'nTimePoints', wt = !is.na(PACC)) %>%
  filter(nTimePoints >= 2)

# Arrange by pacc_time and calculate PACC_change_bl
pacc <- pacc %>% 
  arrange(BID, pacc_time) %>%
  group_by(BID) %>%
  mutate(PACC_bl = PACC[1]) %>%
  mutate(PACC_change_bl = PACC - PACC_bl)

# Create cohort variable
pacc <- pacc %>%
  group_by(BID) %>%
  dplyr::mutate(Cohort = case_when(
    SUBSTUDY == "SF" | SUBSTUDY == "LEARN" ~ "LEARN/SF",
    SUBSTUDY == "A4" & TX == "Placebo" ~ "A4 Placebo",
    SUBSTUDY == "A4" & TX == "Solanezumab" ~ "A4 Treated",
    TRUE ~ NA))

# Merge with data on GM Zscore, GM tertiles
pacc <- merge(pacc, data[, c('BID', 'pTau217', 'GM_ZSCORE', 'GM_tertiles')], by = 'BID', all.x = TRUE)

# Ensure variables are factors
pacc <- pacc %>%
  mutate_at(vars(SUBSTUDY, TX, Cohort, SEX, RACE, ETHNIC, APOE, APOEGN, QSVERSION_PACC), factor)
```

```{r}
lmm_results <- lme(PACC ~ I(pacc_time^2) + pacc_time*pTau217 + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = pacc, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'), control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results)
plot_model(lmm_results, type = c('pred'), terms = c('pacc_time', 'pTau217'))
```
```{r}
lmm_results <- lme(PACC ~ I(pacc_time^2) + pacc_time*GM_ZSCORE+ Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = pacc, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'), control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results)
plot_model(lmm_results, type = c('pred'), terms = c('pacc_time', 'GM_ZSCORE'))
```

```{r}
lmm_results <- lme(PACC ~ I(pacc_time^2) + pacc_time*GM_tertiles+ Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = pacc, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'), control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results)
plot_model(lmm_results, type = c('pred'), terms = c('pacc_time', 'GM_tertiles'))
```

```{r}
lmm_results_gm <- lme(PACC ~ I(pacc_time^2) + pacc_time*pTau217*GM_ZSCORE + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = pacc, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'), control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results_gm)
plot_model(lmm_results_gm, type = c('pred'), terms = c('pacc_time', 'GM_ZSCORE', 'pTau217'))
```

```{r}
lmm_results_tertiles <- lme(PACC ~ I(pacc_time^2) + pacc_time*pTau217*GM_tertiles + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = pacc, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'), control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results_tertiles)
plot_model(lmm_results_tertiles, type = c('pred'), terms = c('pacc_time', 'GM_tertiles', 'pTau217'))
```


## Amyloid positive subjects

As we find significance for pTau217 but they are all apositive to we get significant results if we only look at Amyloid Positive in other biomarkers.

```{r}
data_apos <- subset(data, Amyloid == 'positive')
model_apos_nfl <- lm(NF.L ~ GM_ZSCORE*age, data = data_apos)
summary(model_apos_nfl)
model_apos_gfap <- lm(GFAP ~ GM_ZSCORE*age, data = data_apos)
summary(model_apos_gfap)
```